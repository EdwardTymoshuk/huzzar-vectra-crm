name: ğŸš€ Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 185.242.135.184
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2223
          script: |
            set -e

            cd /var/www/huzzar-vectra-crm

            # --- Node 20 przez nvm w non-login shellu ---
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 20

            # --- Kod ---
            git pull origin main

            # (Opcjonalnie) czystsza instalacja
            rm -rf node_modules .prisma

            # --- ZaleÅ¼noÅ›ci & Prisma ---
            npm ci || npm install
            npx prisma generate
            npx prisma migrate deploy

            # --- Build Next ---
            npm run build

            # --- PM2 bez zaleÅ¼noÅ›ci globalnych ---
            # JeÅ›li proces istnieje -> restart, jeÅ›li nie -> start
            if npx pm2 describe vectra-crm > /dev/null 2>&1; then
              npx pm2 restart vectra-crm
            else
              # uruchom "npm start" jako proces PM2 pod nazwÄ… vectra-crm
              npx pm2 start npm --name "vectra-crm" -- start
            fi

            # zapisz listÄ™ procesÃ³w (auto-restart po reboocie)
            npx pm2 save
