name: 'ğŸš€ Deploy to Server'

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v3

      - name: 'ğŸ” Debug SSH Key Format (first two lines)'
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -n 2

      - name: 'ğŸš€ Deploy via SSH to VPS'
        uses: appleboy/ssh-action@master
        with:
          host: 57.128.227.195
          username: debian
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd /var/www/huzzar-vectra-crm

            echo "=== ğŸ§© Loading Node.js environment ==="
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 20

            echo "=== ğŸ“¦ Updating source code ==="
            git pull origin main

            echo "=== ğŸ§¹ Cleaning old modules ==="
            rm -rf node_modules .prisma

            echo "=== ğŸ“¦ Installing dependencies ==="
            npm ci || npm install

            echo "=== ğŸ” Loading environment variables ==="
            export $(cat .env.production | grep -v '^#' | xargs)

            echo "=== âš™ï¸ Generating Prisma client ==="
            npx prisma generate

            echo "=== ğŸ—„ï¸ Applying database migrations ==="
            # Try to apply migrations, but continue even if one fails
            if ! npx prisma migrate deploy; then
              echo "âš ï¸ WARNING: Prisma migration failed. Check logs on the server."
              echo "âš ï¸ Continuing deployment to keep application online..."
            fi

            echo "=== ğŸ—ï¸ Building application ==="
            npm run build

            echo "=== ğŸ”„ Restarting service ==="
            sudo systemctl restart huzzar
            echo "=== âœ… Service restarted successfully ==="

            echo "=== ğŸ“Š Checking service status ==="
            sudo systemctl --no-pager --full status huzzar || true

            echo "=== âœ… DEPLOYMENT COMPLETED SUCCESSFULLY ==="
