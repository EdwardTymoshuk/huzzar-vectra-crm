/// -------------------------------------------
/// OPL ORDERS
/// -------------------------------------------
model OplOrder {
  id                String         @id @default(uuid())
  serviceId         String?
  orderNumber       String
  date              DateTime
  timeSlot          OplTimeSlot
  clientPhoneNumber String?
  notes             String?
  status            OplOrderStatus @default(PENDING)
  standard          OplOrderStandard?

  /// If true, UMZ should be added to settlement lines.
  contractRequired Boolean @default(false)

  equipmentRequirements OplOrderEquipmentRequirement[]

  network OplNetworkOeprator

  county       String?
  municipality String?
  city         String
  street       String
  postalCode   String?
  lat          Float?
  lng          Float?

  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  createdSource OplOrderCreatedSource @default(PLANNER)
  operator      String
  type          OplOrderType
  zone          String?
  termChangeFlag String?

  closedAt      DateTime?
  completedAt   DateTime?
  failureReason String?

  transferPending Boolean  @default(false)
  transferToId    String?
  transferTo      OplUser? @relation("OplOrderTransfer", fields: [transferToId], references: [userId])

  attemptNumber   Int        @default(1)
  previousOrderId String?
  previousOrder   OplOrder?  @relation("OrderAttempts", fields: [previousOrderId], references: [id])
  attempts        OplOrder[] @relation("OrderAttempts")

  assignments OplOrderAssignment[]

  /// Wizard state used to generate settlement entries deterministically.
  billingConfig OplOrderBillingConfig?

  /// Final billing lines used for reports/payouts (source of truth).
  settlementEntries     OplOrderSettlementEntry[]
  suggestedBaseWorkCode OplBaseWorkCode?

  /// Warehouse integrations.
  assignedEquipment OplOrderEquipment[]   @relation("OrderToOrderEquipment")
  usedMaterials     OplOrderMaterial[]
  warehouseHistory  OplWarehouseHistory[] @relation("OrderToWarehouseHistory")

  /// Audit trail.
  history OplOrderHistory[]

  @@unique([orderNumber, city, street, attemptNumber])
  @@schema("opl")
}

/// Wizard state used to build settlement entries deterministically.
/// This is NOT the source of truth for payouts.
model OplOrderBillingConfig {
  id String @id @default(uuid())

  orderId String   @unique
  order   OplOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  /// Exactly one base work code.
  baseWorkCode OplBaseWorkCode

  /// Activation (1P / 2P / 3P / UTD), if applicable.
  activationType OplActivationType?

  /// List of addons selected or calculated during completion.
  addons OplOrderBillingAddon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("opl")
}

model OplOrderBillingAddon {
  id String @id @default(uuid())

  billingConfigId String
  billingConfig   OplOrderBillingConfig @relation(fields: [billingConfigId], references: [id], onDelete: Cascade)

  code OplAddonCode

  /// Quantity >= 1
  quantity Int

  /// True if auto-added by business rules (e.g. ZJWEW).
  autoAdded Boolean @default(false)

  @@unique([billingConfigId, code])
  @@schema("opl")
}

/// -------------------------------------------
/// ORDER â†” TECHNICIAN ASSIGNMENT (N:N)
/// -------------------------------------------
model OplOrderAssignment {
  id           String   @id @default(uuid())
  orderId      String
  technicianId String
  assignedAt   DateTime @default(now())

  order      OplOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  technician OplUser  @relation("OplOrderAssignmentsByTechnician", fields: [technicianId], references: [userId])

  @@unique([orderId, technicianId])
  @@index([technicianId])
  @@schema("opl")
}

/// -------------------------------------------
/// ORDER MATERIALS
/// -------------------------------------------
model OplOrderMaterial {
  id         String          @id @default(uuid())
  orderId    String
  materialId String
  quantity   Int
  unit       OplMaterialUnit

  material OplMaterialDefinition @relation("MaterialToOrderMaterial", fields: [materialId], references: [id])
  order    OplOrder              @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@schema("opl")
}

/// -------------------------------------------
/// ORDER SETTLEMENT / BILLING (SOURCE OF TRUTH)
/// -------------------------------------------
model OplOrderSettlementEntry {
  id       String @id @default(uuid())
  orderId  String
  code     String
  quantity Int

  rate  OplRateDefinition @relation("RateDefinitionToSettlement", fields: [code], references: [code])
  order OplOrder          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@schema("opl")
}

/// -------------------------------------------
/// ASSIGNED EQUIPMENT
/// -------------------------------------------
model OplOrderEquipment {
  id          String @id @default(uuid())
  orderId     String
  warehouseId String

  order     OplOrder     @relation("OrderToOrderEquipment", fields: [orderId], references: [id], onDelete: Cascade)
  warehouse OplWarehouse @relation("WarehouseToOrderEquipment", fields: [warehouseId], references: [id])

  @@unique([orderId, warehouseId])
  @@index([orderId])
  @@schema("opl")
}

/// -------------------------------------------
/// ORDER HISTORY / AUDIT
/// -------------------------------------------
model OplOrderHistory {
  id            String         @id @default(uuid())
  orderId       String
  changedById   String
  changeDate    DateTime       @default(now())
  statusBefore  OplOrderStatus
  statusAfter   OplOrderStatus
  notes         String?
  equipmentUsed String[]

  changedBy OplUser  @relation("OplOrderHistoryByUser", fields: [changedById], references: [userId])
  order     OplOrder @relation(fields: [orderId], references: [id])

  @@schema("opl")
}

model OplOrderEquipmentRequirement {
  id                 String @id @default(uuid())
  orderId            String
  deviceDefinitionId String
  quantity           Int    @default(1)

  order            OplOrder            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  deviceDefinition OplDeviceDefinition @relation(fields: [deviceDefinitionId], references: [id])

  @@unique([orderId, deviceDefinitionId])
  @@schema("opl")
}
