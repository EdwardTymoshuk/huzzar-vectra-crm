model OplWarehouse {
  id                   String                    @id @default(uuid())
  itemType             OplWarehouseItemType
  name                 String
  category             OplDeviceCategory?
  serialNumber         String?                   @unique
  quantity             Int
  unit                 OplMaterialUnit           @default(PIECE)
  price                Float
  status               OplWarehouseStatus
  assignedToId         String?
  transferToId         String?
  transferPending      Boolean                   @default(false)
  materialDefinitionId String?
  locationId           String?
  index                String?
  alarmAlert           Int?                      @default(5)
  warningAlert         Int?                      @default(10)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  transferLines        OplLocationTransferLine[] @relation("WarehouseToTransferLines")
  orderAssignments     OplOrderEquipment[]       @relation("WarehouseToOrderEquipment")
  assignedTo           OplUser?                  @relation("OplWarehouseAssignedTo", fields: [assignedToId], references: [userId])
  location             Location?                 @relation(fields: [locationId], references: [id])
  materialDefinition   OplMaterialDefinition?    @relation("MaterialDefinitionToWarehouse", fields: [materialDefinitionId], references: [id])
  transferTo           OplUser?                  @relation("OplWarehouseTransfer", fields: [transferToId], references: [userId])
  history              OplWarehouseHistory[]

  @@index([itemType])
  @@index([locationId])
  @@index([assignedToId])
  @@schema("opl")
}

model OplWarehouseHistory {
  id                 String               @id @default(uuid())
  warehouseItemId    String
  action             OplWarehouseAction
  performedById      String
  assignedToId       String?
  assignedOrderId    String?
  fromLocationId     String?
  toLocationId       String?
  locationTransferId String?
  quantity           Int?
  notes              String?
  actionDate         DateTime             @default(now())
  assignedOrder      OplOrder?            @relation("OrderToWarehouseHistory", fields: [assignedOrderId], references: [id])
  assignedTo         OplUser?             @relation("OplWHAssignedTo", fields: [assignedToId], references: [userId])
  fromLocation       Location?            @relation("OplFromLocationHistory", fields: [fromLocationId], references: [id])
  locationTransfer   OplLocationTransfer? @relation("LocationTransferToHistory", fields: [locationTransferId], references: [id])
  performedBy        OplUser              @relation("OplWHPerformedBy", fields: [performedById], references: [userId])
  toLocation         Location?            @relation("OplToLocationHistory", fields: [toLocationId], references: [id])
  warehouseItem      OplWarehouse         @relation(fields: [warehouseItemId], references: [id])

  @@index([warehouseItemId])
  @@index([action])
  @@index([actionDate])
  @@schema("opl")
}

model OplLocationTransfer {
  id             String                    @id @default(uuid())
  fromLocationId String
  toLocationId   String
  status         OplLocationTransferStatus @default(REQUESTED)
  requestedById  String
  confirmedById  String?
  confirmedAt    DateTime?
  notes          String?
  createdAt      DateTime                  @default(now())
  confirmedBy    OplUser?                  @relation("OplConfirmedTransfers", fields: [confirmedById], references: [userId])
  fromLocation   Location                  @relation("OplTransfersFromLocation", fields: [fromLocationId], references: [id])
  requestedBy    OplUser                   @relation("OplRequestedTransfers", fields: [requestedById], references: [userId])
  toLocation     Location                  @relation("OplTransfersToLocation", fields: [toLocationId], references: [id])
  lines          OplLocationTransferLine[]
  histories      OplWarehouseHistory[]     @relation("LocationTransferToHistory")

  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@schema("opl")
}

model OplLocationTransferLine {
  id                   String                 @id @default(uuid())
  transferId           String
  itemType             OplWarehouseItemType
  warehouseItemId      String?
  materialDefinitionId String?
  quantity             Int?
  unit                 OplMaterialUnit?
  nameSnapshot         String?
  indexSnapshot        String?
  category             OplDeviceCategory?
  materialDefinition   OplMaterialDefinition? @relation("MaterialDefinitionToTransferLines", fields: [materialDefinitionId], references: [id])
  transfer             OplLocationTransfer    @relation(fields: [transferId], references: [id])
  warehouseItem        OplWarehouse?          @relation("WarehouseToTransferLines", fields: [warehouseItemId], references: [id])

  @@index([transferId])
  @@index([warehouseItemId])
  @@schema("opl")
}

model OplMaterialDefinition {
  id               String                         @id @default(uuid())
  name             String                         @unique
  index            String?
  unit             OplMaterialUnit                @default(PIECE)
  price            Float?                         @default(0)
  alarmAlert       Int?                           @default(5)
  warningAlert     Int?                           @default(10)
  transferLines    OplLocationTransferLine[]      @relation("MaterialDefinitionToTransferLines")
  orderMaterials   OplOrderMaterial[]             @relation("MaterialToOrderMaterial")
  materialDeficits OplTechnicianMaterialDeficit[]
  warehouseItems   OplWarehouse[]                 @relation("MaterialDefinitionToWarehouse")

  @@schema("opl")
}

model OplDeviceDefinition {
  id           String            @id @default(uuid())
  category     OplDeviceCategory
  name         String
  price        Float?            @default(0)
  alarmAlert   Int?              @default(5)
  warningAlert Int?              @default(10)

  orderEquipmentRequirements OplOrderEquipmentRequirement[]

  @@schema("opl")
}

model OplTechnicianMaterialDeficit {
  id                   String                @id @default(uuid())
  technicianId         String
  materialDefinitionId String
  quantity             Int
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  materialDefinition   OplMaterialDefinition @relation(fields: [materialDefinitionId], references: [id])
  technician           OplUser               @relation("OplMaterialDeficitTechnician", fields: [technicianId], references: [userId])

  @@unique([technicianId, materialDefinitionId])
  @@schema("opl")
}
