model OplUser {
  userId                    String                         @id
  active                    Boolean                        @default(true)
  createdAt                 DateTime                       @default(now())
  updatedAt                 DateTime                       @updatedAt
  deactivatedAt             DateTime?
  transfersConfirmed        OplLocationTransfer[]          @relation("OplConfirmedTransfers")
  transfersRequested        OplLocationTransfer[]          @relation("OplRequestedTransfers")
  ordersTransferred         OplOrder[]                     @relation("OplOrderTransfer")
  orderHistory              OplOrderHistory[]              @relation("OplOrderHistoryByUser")
  materialDeficits          OplTechnicianMaterialDeficit[] @relation("OplMaterialDeficitTechnician")
  user                      User                           @relation("UserToOplUser", fields: [userId], references: [id])
  warehouseItems            OplWarehouse[]                 @relation("OplWarehouseAssignedTo")
  transferredItems          OplWarehouse[]                 @relation("OplWarehouseTransfer")
  warehouseHistoryAssigned  OplWarehouseHistory[]          @relation("OplWHAssignedTo")
  warehouseHistoryPerformed OplWarehouseHistory[]          @relation("OplWHPerformedBy")
  addressNotesCreated       OplAddressNote[]               @relation("OplAddressNotesByUser")
  primaryTeams             OplTeam[]                      @relation("OplTeamPrimaryTechnician")
  secondaryTeams           OplTeam[]                      @relation("OplTeamSecondaryTechnician")
  teamsCreated             OplTeam[]                      @relation("OplTeamCreatedBy")

  orderAssignments OplOrderAssignment[] @relation("OplOrderAssignmentsByTechnician")

  @@schema("opl")
}

model OplTeam {
  id String @id @default(uuid())

  name   String?
  active Boolean @default(true)

  technician1Id String
  technician2Id String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdById String?

  technician1 OplUser  @relation("OplTeamPrimaryTechnician", fields: [technician1Id], references: [userId])
  technician2 OplUser  @relation("OplTeamSecondaryTechnician", fields: [technician2Id], references: [userId])
  createdBy   OplUser? @relation("OplTeamCreatedBy", fields: [createdById], references: [userId])

  @@index([technician1Id])
  @@index([technician2Id])
  @@index([active])
  @@schema("opl")
}

model OplRateDefinition {
  id     String @id @default(uuid())
  code   String @unique
  amount Float

  settlements OplOrderSettlementEntry[] @relation("RateDefinitionToSettlement")

  @@schema("opl")
}

model OplOperatorDefinition {
  operator String @id

  @@schema("opl")
}

model OplAddressNote {
  id String @id @default(uuid())

  city       String
  street     String
  cityNorm   String
  streetNorm String

  /// Examples: "1,2,3,10" / "1-20". Empty means entire street.
  buildingScope String?

  note   String
  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String
  createdBy   OplUser @relation("OplAddressNotesByUser", fields: [createdById], references: [userId])

  @@index([cityNorm, streetNorm, active])
  @@index([createdAt])
  @@schema("opl")
}
