model OplUser {
  userId                    String                         @id
  active                    Boolean                        @default(true)
  createdAt                 DateTime                       @default(now())
  updatedAt                 DateTime                       @updatedAt
  deactivatedAt             DateTime?
  transfersConfirmed        OplLocationTransfer[]          @relation("OplConfirmedTransfers")
  transfersRequested        OplLocationTransfer[]          @relation("OplRequestedTransfers")
  ordersTransferred         OplOrder[]                     @relation("OplOrderTransfer")
  orderHistory              OplOrderHistory[]              @relation("OplOrderHistoryByUser")
  materialDeficits          OplTechnicianMaterialDeficit[] @relation("OplMaterialDeficitTechnician")
  user                      User                           @relation("UserToOplUser", fields: [userId], references: [id])
  warehouseItems            OplWarehouse[]                 @relation("OplWarehouseAssignedTo")
  transferredItems          OplWarehouse[]                 @relation("OplWarehouseTransfer")
  warehouseHistoryAssigned  OplWarehouseHistory[]          @relation("OplWHAssignedTo")
  warehouseHistoryPerformed OplWarehouseHistory[]          @relation("OplWHPerformedBy")
  addressNotesCreated       OplAddressNote[]               @relation("OplAddressNotesByUser")
  absences                  OplTechnicianAbsence[]         @relation("OplTechnicianAbsencesByUser")
  absencesCreated           OplTechnicianAbsence[]         @relation("OplTechnicianAbsencesCreatedBy")
  primaryTeams             OplTeam[]                      @relation("OplTeamPrimaryTechnician")
  secondaryTeams           OplTeam[]                      @relation("OplTeamSecondaryTechnician")
  teamsCreated             OplTeam[]                      @relation("OplTeamCreatedBy")
  npsImports               OplNpsEntry[]                  @relation("OplNpsImportedBy")
  leadsAssigned            OplLeadEntry[]                 @relation("OplLeadAssignedTo")
  leadsCreated             OplLeadEntry[]                 @relation("OplLeadCreatedBy")

  orderAssignments OplOrderAssignment[] @relation("OplOrderAssignmentsByTechnician")

  @@schema("opl")
}

model OplTeam {
  id String @id @default(uuid())

  name   String?
  active Boolean @default(true)

  technician1Id String
  technician2Id String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdById String?

  technician1 OplUser  @relation("OplTeamPrimaryTechnician", fields: [technician1Id], references: [userId])
  technician2 OplUser  @relation("OplTeamSecondaryTechnician", fields: [technician2Id], references: [userId])
  createdBy   OplUser? @relation("OplTeamCreatedBy", fields: [createdById], references: [userId])

  @@index([technician1Id])
  @@index([technician2Id])
  @@index([active])
  @@schema("opl")
}

model OplRateDefinition {
  id     String @id @default(uuid())
  code   String @unique
  amount Float

  settlements OplOrderSettlementEntry[] @relation("RateDefinitionToSettlement")

  @@schema("opl")
}

model OplOperatorDefinition {
  operator String @id

  @@schema("opl")
}

model OplZoneDefinition {
  zone      String  @id
  active    Boolean @default(true)
  sortOrder Int     @default(0)

  @@index([active, sortOrder])
  @@schema("opl")
}

model OplAddressNote {
  id String @id @default(uuid())

  city       String
  street     String
  cityNorm   String
  streetNorm String

  /// Examples: "1,2,3,10" / "1-20". Empty means entire street.
  buildingScope String?

  note   String
  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String
  createdBy   OplUser @relation("OplAddressNotesByUser", fields: [createdById], references: [userId])

  @@index([cityNorm, streetNorm, active])
  @@index([createdAt])
  @@schema("opl")
}

model OplTechnicianAbsence {
  id String @id @default(uuid())

  technicianId String
  dateFrom     DateTime
  dateTo       DateTime
  type         OplTechnicianAbsenceType @default(OTHER)
  reason       String?
  active       Boolean                  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdById String?

  technician OplUser  @relation("OplTechnicianAbsencesByUser", fields: [technicianId], references: [userId])
  createdBy  OplUser? @relation("OplTechnicianAbsencesCreatedBy", fields: [createdById], references: [userId])

  @@index([technicianId, active])
  @@index([dateFrom, dateTo, active])
  @@schema("opl")
}

model OplNpsEntry {
  id String @id @default(uuid())

  orderNumber    String
  technicianName String?
  zone           String?
  operator       String?
  q6Score        Int

  orderId String?
  order   OplOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  importedAt   DateTime @default(now())
  importedById String?
  importedBy   OplUser? @relation("OplNpsImportedBy", fields: [importedById], references: [userId])

  @@unique([orderNumber])
  @@index([zone])
  @@index([technicianName])
  @@index([operator])
  @@schema("opl")
}

model OplLeadEntry {
  id String @id @default(uuid())

  zone       String
  address    String
  leadNumber String
  operator   String @default("ORANGE")

  technicianId   String?
  technicianName String?
  technician     OplUser? @relation("OplLeadAssignedTo", fields: [technicianId], references: [userId], onDelete: SetNull)

  createdAt DateTime @default(now())

  createdById String?
  createdBy   OplUser? @relation("OplLeadCreatedBy", fields: [createdById], references: [userId], onDelete: SetNull)

  @@index([zone])
  @@index([operator])
  @@index([createdAt])
  @@index([leadNumber])
  @@schema("opl")
}
