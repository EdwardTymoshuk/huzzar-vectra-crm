/// -------------------------------------------
/// VECTRA WAREHOUSE (schema: vectra)
/// -------------------------------------------

model VectraWarehouse {
  id                   String                  @id @default(uuid())
  itemType             VectraWarehouseItemType
  name                 String
  category             VectraDeviceCategory?
  serialNumber         String?                 @unique
  quantity             Int
  unit                 VectraMaterialUnit      @default(PIECE)
  price                Float
  status               VectraWarehouseStatus
  assignedToId         String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  alarmAlert           Int?                    @default(5)
  index                String?
  warningAlert         Int?                    @default(10)
  materialDefinitionId String?
  transferPending      Boolean                 @default(false)
  transferToId         String?
  locationId           String?

  transferLines    VectraLocationTransferLine[] @relation("WarehouseToTransferLines")
  orderAssignments VectraOrderEquipment[]       @relation("WarehouseToOrderEquipment")

  assignedTo         VectraUser?               @relation("VectraWarehouseAssignedTo", fields: [assignedToId], references: [userId])
  transferTo         VectraUser?               @relation("VectraWarehouseTransfer", fields: [transferToId], references: [userId])
  location           VectraWarehouseLocation?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  materialDefinition VectraMaterialDefinition? @relation("MaterialDefinitionToWarehouse", fields: [materialDefinitionId], references: [id])

  history VectraWarehouseHistory[]
}

model VectraWarehouseHistory {
  id                 String                @id @default(uuid())
  warehouseItemId    String
  action             VectraWarehouseAction
  performedById      String
  assignedToId       String?
  actionDate         DateTime              @default(now())
  notes              String?
  quantity           Int?
  assignedOrderId    String?
  fromLocationId     String?
  locationTransferId String?
  toLocationId       String?

  warehouseItem VectraWarehouse @relation(fields: [warehouseItemId], references: [id])

  assignedOrder VectraOrder?             @relation("OrderToWarehouseHistory", fields: [assignedOrderId], references: [id])
  fromLocation  VectraWarehouseLocation? @relation("FromLocationHistory", fields: [fromLocationId], references: [id])
  toLocation    VectraWarehouseLocation? @relation("ToLocationHistory", fields: [toLocationId], references: [id])

  locationTransfer VectraLocationTransfer? @relation("LocationTransferToHistory", fields: [locationTransferId], references: [id])

  assignedTo  VectraUser? @relation("VectraWHAssignedTo", fields: [assignedToId], references: [userId])
  performedBy VectraUser  @relation("VectraWHPerformedBy", fields: [performedById], references: [userId])
}

model VectraLocationTransfer {
  id             String                       @id @default(uuid())
  fromLocationId String
  toLocationId   String
  status         VectraLocationTransferStatus @default(REQUESTED)
  notes          String?
  createdAt      DateTime                     @default(now())
  requestedById  String
  confirmedById  String?
  confirmedAt    DateTime?

  fromLocation VectraWarehouseLocation @relation("TransfersFromLocation", fields: [fromLocationId], references: [id])
  toLocation   VectraWarehouseLocation @relation("TransfersToLocation", fields: [toLocationId], references: [id])

  requestedBy VectraUser  @relation("VectraRequestedTransfers", fields: [requestedById], references: [userId])
  confirmedBy VectraUser? @relation("VectraConfirmedTransfers", fields: [confirmedById], references: [userId])

  lines     VectraLocationTransferLine[]
  histories VectraWarehouseHistory[]     @relation("LocationTransferToHistory")

  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
}

model VectraLocationTransferLine {
  id                   String                  @id @default(uuid())
  transferId           String
  itemType             VectraWarehouseItemType
  warehouseItemId      String?
  materialDefinitionId String?
  quantity             Int?
  unit                 VectraMaterialUnit?
  nameSnapshot         String?
  indexSnapshot        String?
  category             VectraDeviceCategory?

  transfer           VectraLocationTransfer    @relation(fields: [transferId], references: [id])
  warehouseItem      VectraWarehouse?          @relation("WarehouseToTransferLines", fields: [warehouseItemId], references: [id])
  materialDefinition VectraMaterialDefinition? @relation("MaterialDefinitionToTransferLines", fields: [materialDefinitionId], references: [id])

  @@index([transferId])
  @@index([warehouseItemId])
  @@index([materialDefinitionId])
}

model VectraMaterialDefinition {
  id           String             @id @default(uuid())
  name         String             @unique
  alarmAlert   Int?               @default(5)
  index        String?
  warningAlert Int?               @default(10)
  unit         VectraMaterialUnit @default(PIECE)
  price        Float?             @default(0)

  transferLines    VectraLocationTransferLine[]      @relation("MaterialDefinitionToTransferLines")
  orderMaterials   VectraOrderMaterial[]             @relation("MaterialToOrderMaterial")
  warehouseItems   VectraWarehouse[]                 @relation("MaterialDefinitionToWarehouse")
  materialDeficits VectraTechnicianMaterialDeficit[]
}

model VectraDeviceDefinition {
  id           String               @id @default(uuid())
  category     VectraDeviceCategory
  name         String
  alarmAlert   Int?                 @default(5)
  warningAlert Int?                 @default(10)
  price        Float?               @default(0)
}

model VectraTechnicianMaterialDeficit {
  id                   String   @id @default(uuid())
  technicianId         String
  materialDefinitionId String
  quantity             Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  technician         VectraUser               @relation("VectraMaterialDeficitTechnician", fields: [technicianId], references: [userId])
  materialDefinition VectraMaterialDefinition @relation(fields: [materialDefinitionId], references: [id])

  @@unique([technicianId, materialDefinitionId])
}
