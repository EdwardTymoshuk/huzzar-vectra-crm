//prisma/schema/vectra/vectra-warehouse.prisma

/// -------------------------------------------
/// VECTRA WAREHOUSE (schema: vectra)
/// -------------------------------------------

model VectraWarehouse {
  @@schema("vectra")
  id                   String                  @id @default(uuid())
  itemType             VectraWarehouseItemType
  name                 String
  category             VectraDeviceCategory?
  serialNumber         String?                 @unique
  quantity             Int
  unit                 VectraMaterialUnit      @default(PIECE)
  price                Float
  status               VectraWarehouseStatus
  assignedToId         String?
  transferToId         String?
  transferPending      Boolean                 @default(false)
  materialDefinitionId String?
  locationId           String?
  index                String?
  alarmAlert           Int?                    @default(5)
  warningAlert         Int?                    @default(10)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  assignedTo VectraUser?              @relation("VectraWarehouseAssignedTo", fields: [assignedToId], references: [userId])
  transferTo VectraUser?              @relation("VectraWarehouseTransfer", fields: [transferToId], references: [userId])
  location   VectraWarehouseLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  materialDefinition VectraMaterialDefinition? @relation("MaterialDefinitionToWarehouse", fields: [materialDefinitionId], references: [id])

  transferLines    VectraLocationTransferLine[] @relation("WarehouseToTransferLines")
  orderAssignments VectraOrderEquipment[]       @relation("WarehouseToOrderEquipment")
  history          VectraWarehouseHistory[]

  @@index([itemType])
  @@index([locationId])
  @@index([assignedToId])
}

/// -------------------------------------------
/// WAREHOUSE HISTORY
/// -------------------------------------------

model VectraWarehouseHistory {
  @@schema("vectra")
  id                 String                @id @default(uuid())
  warehouseItemId    String
  action             VectraWarehouseAction
  performedById      String
  assignedToId       String?
  assignedOrderId    String?
  fromLocationId     String?
  toLocationId       String?
  locationTransferId String?
  quantity           Int?
  notes              String?
  actionDate         DateTime              @default(now())

  warehouseItem    VectraWarehouse          @relation(fields: [warehouseItemId], references: [id])
  assignedOrder    VectraOrder?             @relation("OrderToWarehouseHistory", fields: [assignedOrderId], references: [id])
  fromLocation     VectraWarehouseLocation? @relation("VectraFromLocationHistory", fields: [fromLocationId], references: [id])
  toLocation       VectraWarehouseLocation? @relation("VectraToLocationHistory", fields: [toLocationId], references: [id])
  locationTransfer VectraLocationTransfer?  @relation("LocationTransferToHistory", fields: [locationTransferId], references: [id])

  assignedTo  VectraUser? @relation("VectraWHAssignedTo", fields: [assignedToId], references: [userId])
  performedBy VectraUser  @relation("VectraWHPerformedBy", fields: [performedById], references: [userId])

  @@index([warehouseItemId])
  @@index([action])
  @@index([actionDate])
}

/// -------------------------------------------
/// LOCATION TRANSFER
/// -------------------------------------------

model VectraLocationTransfer {
  @@schema("vectra")
  id             String                       @id @default(uuid())
  fromLocationId String
  toLocationId   String
  status         VectraLocationTransferStatus @default(REQUESTED)
  requestedById  String
  confirmedById  String?
  confirmedAt    DateTime?
  notes          String?
  createdAt      DateTime                     @default(now())

  fromLocation VectraWarehouseLocation @relation("VectraTransfersFromLocation", fields: [fromLocationId], references: [id])
  toLocation   VectraWarehouseLocation @relation("VectraTransfersToLocation", fields: [toLocationId], references: [id])

  requestedBy VectraUser  @relation("VectraRequestedTransfers", fields: [requestedById], references: [userId])
  confirmedBy VectraUser? @relation("VectraConfirmedTransfers", fields: [confirmedById], references: [userId])

  lines     VectraLocationTransferLine[]
  histories VectraWarehouseHistory[]     @relation("LocationTransferToHistory")

  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
}

/// -------------------------------------------
/// LOCATION TRANSFER LINE
/// -------------------------------------------

model VectraLocationTransferLine {
  @@schema("vectra")
  id                   String                  @id @default(uuid())
  transferId           String
  itemType             VectraWarehouseItemType
  warehouseItemId      String?
  materialDefinitionId String?
  quantity             Int?
  unit                 VectraMaterialUnit?
  nameSnapshot         String?
  indexSnapshot        String?
  category             VectraDeviceCategory?

  transfer           VectraLocationTransfer    @relation(fields: [transferId], references: [id])
  warehouseItem      VectraWarehouse?          @relation("WarehouseToTransferLines", fields: [warehouseItemId], references: [id])
  materialDefinition VectraMaterialDefinition? @relation("MaterialDefinitionToTransferLines", fields: [materialDefinitionId], references: [id])

  @@index([transferId])
  @@index([warehouseItemId])
}

/// -------------------------------------------
/// MATERIAL DEFINITION
/// -------------------------------------------

model VectraMaterialDefinition {
  @@schema("vectra")
  id           String             @id @default(uuid())
  name         String             @unique
  index        String?
  unit         VectraMaterialUnit @default(PIECE)
  price        Float?             @default(0)
  alarmAlert   Int?               @default(5)
  warningAlert Int?               @default(10)

  warehouseItems   VectraWarehouse[]                 @relation("MaterialDefinitionToWarehouse")
  transferLines    VectraLocationTransferLine[]      @relation("MaterialDefinitionToTransferLines")
  orderMaterials   VectraOrderMaterial[]             @relation("MaterialToOrderMaterial")
  materialDeficits VectraTechnicianMaterialDeficit[]
}

/// -------------------------------------------
/// DEVICE DEFINITION
/// -------------------------------------------

model VectraDeviceDefinition {
  @@schema("vectra")
  id           String               @id @default(uuid())
  category     VectraDeviceCategory
  name         String
  price        Float?               @default(0)
  alarmAlert   Int?                 @default(5)
  warningAlert Int?                 @default(10)
}

/// -------------------------------------------
/// TECHNICIAN MATERIAL DEFICIT
/// -------------------------------------------

model VectraTechnicianMaterialDeficit {
  @@schema("vectra")
  id                   String   @id @default(uuid())
  technicianId         String
  materialDefinitionId String
  quantity             Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  technician         VectraUser               @relation("VectraMaterialDeficitTechnician", fields: [technicianId], references: [userId])
  materialDefinition VectraMaterialDefinition @relation(fields: [materialDefinitionId], references: [id])

  @@unique([technicianId, materialDefinitionId])
}

/// -------------------------------------------
/// WAREHOUSE LOCATION (VECTRA ONLY)
/// -------------------------------------------

model VectraWarehouseLocation {
  @@schema("vectra")
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items         VectraWarehouse[]
  historyFrom   VectraWarehouseHistory[] @relation("VectraFromLocationHistory")
  historyTo     VectraWarehouseHistory[] @relation("VectraToLocationHistory")
  transfersFrom VectraLocationTransfer[] @relation("VectraTransfersFromLocation")
  transfersTo   VectraLocationTransfer[] @relation("VectraTransfersToLocation")
}
